"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.default = void 0;var _kit = await jitiImport("@nuxt/kit");
var _utils = await jitiImport("consola/utils");
var _defu = _interopRequireDefault(await jitiImport("defu"));
var _nodePath = await jitiImport("node:path");
var _getPortPlease = await jitiImport("get-port-please");
var _ufo = await jitiImport("ufo");
var _common = await jitiImport("storybook/internal/common");
var _coreServer = await jitiImport("storybook/internal/core-server");function _interopRequireDefault(e) {return e && e.__esModule ? e : { default: e };}

const logger = (0, _kit.useLogger)("nuxt:storybook");

const buildLogger = logger.withTag("build");
function printError(error) {
  if (error instanceof Error) {
    if (error.error) {
      buildLogger.error(error.error);
    } else if (error.stats?.compilation?.errors) {
      error.stats.compilation.errors.forEach((e) => buildLogger.log(e));
    } else {
      buildLogger.error(error);
    }
  } else if (error.compilation?.errors) {
    error.compilation.errors.forEach((e) => buildLogger.log(e));
  }
  buildLogger.warn(
    error.close ? `
          FATAL broken build!, will close the process,
          Fix the error below and restart storybook.
        ` : `
          Broken build, fix the error above.
          You may need to refresh the browser.
        `
  );
}
async function setupStorybook(options, nuxt) {
  const storybookRoute = options.route;
  const storybookServerPort = await (0, _getPortPlease.getPort)({
    ports: [options.port || 6006, 6007, 6008, 6009, 6010]
  });
  const projectDir = (0, _nodePath.resolve)(nuxt.options.rootDir);
  const configDir = (0, _nodePath.resolve)(projectDir, ".storybook");
  nuxt.options.typescript = (0, _defu.default)(nuxt.options.typescript, {
    tsConfig: {
      include: [(0, _nodePath.relative)(nuxt.options.buildDir, (0, _nodePath.resolve)(configDir, "**/*"))]
    }
  });
  const storybookOptions = {
    port: storybookServerPort,
    configDir,
    configType: "DEVELOPMENT",
    cache: _common.cache,
    // Don't check for storybook updates (we're using the latest version)
    versionUpdates: false,
    quiet: options.logLevel < 4,
    // 4 = debug
    https: Boolean(options.https),
    sslCert: typeof options.https === "object" ? options.https.cert : void 0,
    sslKey: typeof options.https === "object" ? options.https.key : void 0
  };
  if (!nuxt.options.dev) return;
  logger.verbose("Starting Storybook");
  const result = await (0, _coreServer.withTelemetry)(
    "dev",
    {
      cliOptions: {},
      presetOptions: {
        ...storybookOptions,
        corePresets: [],
        overridePresets: []
      },
      printError
    },
    () => (0, _coreServer.buildDevStandalone)(storybookOptions)
  );
  if (!result) {
    logger.error("Failed to start Storybook");
    return;
  }
  logger.log(
    `  \u279C Storybook: ${_utils.colors.underline((0, _ufo.withTrailingSlash)(result.address))}`
  );
  logger.verbose(
    `  \u279C Storybook: ${_utils.colors.underline((0, _ufo.withTrailingSlash)(result.networkAddress))}`
  );
  nuxt.hook("build:done", () => {
    logger.verbose(" ");
    logger.verbose("\u2714 Storybook build done  ");
    logger.verbose("  ");
    process.env = process.env || {};
    process.env.__STORYBOOK__ = JSON.stringify(options);
  });
  nuxt.hook("devtools:customTabs", (tabs) => {
    tabs.push({
      // unique identifier
      name: "nuxt-storybook",
      // title to display in the tab
      title: "Storybook",
      // any icon from Iconify, or a URL to an image
      icon: "devicon:storybook",
      // iframe view
      view: {
        type: "iframe",
        // absolute URL to the iframes
        src: `${storybookRoute}/`
      }
    });
  });
}

const _module = exports.default = (0, _kit.defineNuxtModule)({
  meta: {
    name: "@nuxtjs/storybook",
    configKey: "storybook",
    compatibility: {
      nuxt: ">=3.0.0",
      builder: {
        // Not compatible with webpack
        webpack: false
      }
    }
  },
  defaults: (nuxt) => ({
    host: process.env?.STORYBOOK_HOST || "http://localhost",
    route: "/_storybook",
    port: 6006,
    logLevel: nuxt.options.logLevel === "silent" ? 0 : 3,
    enabled: true,
    https: false
  }),
  async setup(options, nuxt) {
    if (process.env?.__STORYBOOK__ || !options.enabled) return;
    logger.level = options.logLevel;
    logger.verbose("\u{1F50C}  Storybook Module Setup");
    setupStorybook(options, nuxt);
  }
}); /* v9-af85e63d8f0159ff */
